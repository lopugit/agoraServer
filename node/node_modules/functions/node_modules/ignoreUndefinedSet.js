module.exports = async function (
  // depending on your namespace & /types version, you can use firebase.firestore.<name> instead
  reference,
  data,
  options,
  checkNestedObjects = true
) {
  const isPlainObject = (val) =>
     typeof val === 'object' && val !== null && !(val instanceof Date) && !Array.isArray(val)
  const keepDefinedProperties = (
     obj,
     nestedCheck = true,
  ) =>
   Object.entries(data).reduce(
      (result, [key, value]) => (
           value === undefined
                ? result
                : (nestedCheck && isPlainObject(value))
                   ? Object.assign(result, { [key]: keepDefinedProperties(value) })
                   : Object.assign(result, { [key]: value })
       ),
      {}
  )
  const onlyDefinedProperties = keepDefinedProperties(data, checkNestedObjects)
  await reference.set(onlyDefinedProperties, { ...options })
}